#!/usr/bin/env node

/**
 * Script to generate CSP hashes for AudioWorklet files
 * Run this script before building to generate the hash file
 */

import { createHash } from 'crypto';
import { readFileSync, writeFileSync } from 'fs';
import { join, dirname } from 'path';
import { fileURLToPath } from 'url';

const __dirname = dirname(fileURLToPath(import.meta.url));
const packagesDir = join(__dirname, '..');
const workletDir = join(packagesDir, 'src', 'worklets');

// Worklet files to process
const workletFiles = [
  {
    name: 'audio-concat-processor',
    path: join(workletDir, 'audio-concat-processor.worklet.js')
  },
  {
    name: 'raw-audio-processor', 
    path: join(workletDir, 'raw-audio-processor.worklet.js')
  }
];

// Read worklet source code from actual files
const workletSources = {};
for (const worklet of workletFiles) {
  try {
    const content = readFileSync(worklet.path, 'utf8');
    workletSources[worklet.name] = content;
  } catch (error) {
    console.error(`Error reading ${worklet.name}:`, error.message);
    process.exit(1);
  }
}

// Generate SHA-256 hashes
const hashes = {};
const hashList = [];

console.log('Generating CSP hashes for AudioWorklet source code...\n');

for (const [name, sourceCode] of Object.entries(workletSources)) {
  const hash = createHash('sha256').update(sourceCode, 'utf8').digest('base64');
  const cspHash = `sha256-${hash}`;
  
  hashes[name] = cspHash;
  hashList.push(cspHash);
  
  console.log(`${name}: ${cspHash}`);
}

// Generate TypeScript file with hashes and source code
const tsContent = `// This file is auto-generated by scripts/generate-worklet-hashes.js
// Do not edit manually

/**
 * CSP hashes for AudioWorklet source code
 * Add these to your Content Security Policy script-src directive for CSP-safe static file loading
 */
export const WORKLET_HASHES = ${JSON.stringify(hashes, null, 2)} as const;

/**
 * AudioWorklet source code for fallback blob: URL usage
 */
export const WORKLET_SOURCES = ${JSON.stringify(workletSources, null, 2)} as const;

`;

const outputPath = join(packagesDir, 'src', 'worklet-hashes.ts');
writeFileSync(outputPath, tsContent, 'utf8');

